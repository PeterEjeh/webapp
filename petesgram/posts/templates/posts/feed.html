{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            {% for post in posts %}
            <div class="card mb-4 shadow-sm">
                <!-- Post Header -->
                <div class="card-header d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <img src="{{ post.user.profile.image.url }}" class="rounded-circle me-2" width="40" height="40">
                        <strong>{{ post.user.username }}</strong>
                    </div>

                    <!-- Follow/Unfollow Button -->
                    {% if post.user != request.user %}
                    <form method="POST" action="{% url 'follow' post.user.username %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm
                            {% if following_status.post.user.username %} btn-outline-secondary {% else %} btn-primary {% endif %}">
                            {% if following_status.post.user.username %} Following {% else %} Follow {% endif %}
                        </button>
                    </form>
                    {% endif %}

                    <!-- JavaScript for Follow/Unfollow -->
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".follow-btn").forEach(button => {
                    button.addEventListener("click", function () {
                        let username = this.getAttribute("data-username");

                        fetch(`/follow/${username}/`, {
                            method: "POST",
                            headers: {
                                "X-CSRFToken": "{{ csrf_token }}",
                                "X-Requested-With": "XMLHttpRequest"
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.is_following) {
                                this.innerText = "Following";
                                this.classList.remove("btn-primary");
                                this.classList.add("btn-outline-secondary");
                            } else {
                                this.innerText = "Follow";
                                this.classList.remove("btn-outline-secondary");
                                this.classList.add("btn-primary");
                            }
                        })
                        .catch(error => console.error("Error:", error));
                    });
                });
            });
        </script>
                </div>

                <!-- Post Image/Video -->
                {% if post.image %}
                    <img src="{{ post.image.url }}" class="card-img-top">
                {% elif post.video %}
                    <video class="card-img-top" controls>
                        <source src="{{ post.video.url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                {% endif %}

                <!-- Post Caption -->
                <div class="card-body">
                    <p class="card-text"><strong>{{ post.user.username }}</strong> {{ post.caption }}</p>
                    <p class="text-muted">{{ post.created_at|timesince }} ago</p>

                    <!-- Like Button -->
                    {% if user.is_authenticated %}
                        <form action="{% url 'like_post' post.id %}" method="POST" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                {% if post.id in liked_posts %}
                                    ‚ù§Ô∏è Unlike
                                {% else %}
                                    ü§ç Like
                                {% endif %}
                            </button>
                        </form>
                    {% else %}
                        <p><a href="{% url 'login' %}">Log in</a> to like posts.</p>
                    {% endif %}

                    <span class="text-muted">{{ post.total_likes }} likes</span>

                    <!-- Comment Section -->
                    <form action="{% url 'comment_post' post.id %}" method="POST" class="mt-2">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" name="comment" class="form-control" placeholder="Add a comment..." required>
                            <button type="submit" class="btn btn-outline-primary">Post</button>
                        </div>
                    </form>

                    <!-- Display Comments -->
                    <div class="mt-3">
                        {% for comment in post.comment_set.all %}
                            <p><strong>{{ comment.user.username }}</strong>: {{ comment.text }}</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
